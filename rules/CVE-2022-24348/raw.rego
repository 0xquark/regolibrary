package armo_builtins

deny[msga] {
	deployment := input[_]
	deployment.kind == "Deployment"
	image := deployment.spec.template.spec.containers[i].image
	startswith(image,"quay.io/argoproj/argocd:v")
	isVulnerableImage(image)
	path := sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
    msga := {
			"alertMessage": "You may be vulnerable to CVE-2022-24348",
			"failedPaths": [path],
			"alertObject": { 
                "k8SApiObjects": [deployment]
            },
		}
}

isVulnerableImage(image) {
	version := split(image, ":v")[1]
	versionTriplet := split(version, ".")
	count(versionTriplet) == 3
	majorVersion := to_number(versionTriplet[0])
	minorVersion := to_number(versionTriplet[1])
	subVersion := to_number(versionTriplet[2])  
	isVulnerableVersion(majorVersion,minorVersion,subVersion)
}

isVulnerableVersion(majorVersion, minorVersion, subVersion) {
	majorVersion == 1
} 

isVulnerableVersion(majorVersion, minorVersion, subVersion) {
	majorVersion == 2
	minorVersion == 0
}

isVulnerableVersion(majorVersion, minorVersion, subVersion) {
	majorVersion == 2
	minorVersion == 1
	subVersion < 9
}

isVulnerableVersion(majorVersion, minorVersion, subVersion) {
	majorVersion == 2
	minorVersion == 2
	subVersion < 4
}	

