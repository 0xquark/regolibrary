package armo_builtins

deny[msga] {
	deployment := input[_]
	deployment.kind == "Deployment"
	image := deployment.spec.template.spec.containers[i].image
	is_nginx_image(image)
	is_tag_image(image)
	is_vulnerable(image, deployment.metadata.namespace)
	path := sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
	msga := {
			"alertMessage": sprintf("You may be vulnerable to CVE-2021-25742. Deployment %v", [deployment.metadata.name]),
			"failedPaths": [path],
			"fixPaths":[],
			"alertObject": {"k8SApiObjects": [deployment]},
		}
}

	
is_nginx_image(image) {
	contains(image, "nginx-controller")
}

is_nginx_image(image) {
	contains(image, "ingress-controller")
}

is_nginx_image(image) {
	contains(image, "ingress-nginx")
}

is_vulnerable(image, namespace) {
	contains(image, "@")
	version := split(image, ":")
	tag := split(version[count(version)-2], "@")[0]
    startswith(tag, "v")
    tag <= "v0.49"
}
	
is_vulnerable(image, namespace) {
	contains(image, "@")
	version := split(image, ":")
	tag := split(version[count(version)-2], "@")[0]
    startswith(tag, "v")
    tag  == "v1.0.0"
}

is_vulnerable(image, namespace) {
	not contains(image, "@")
	version := split(image, ":")
	tag := version[count(version)-1]
    startswith(tag, "v")
	tag <= "v0.49"
}

is_vulnerable(image, namespace) {
	not contains(image, "@")
	version := split(image, ":")
	tag := version[count(version)-1]
    startswith(tag, "v")
	tag  == "v1.0.0"
}

###### without 'v'
	
is_vulnerable(image, namespace) {
	contains(image, "@")
	version := split(image, ":")
	tag := split(version[count(version)-2], "@")[0]
    not startswith(tag, "v")
    tag <= "0.49"
}
	
is_vulnerable(image, namespace) {
	contains(image, "@")
	version := split(image, ":")
	tag := split(version[count(version)-2], "@")[0]
    not startswith(tag, "v")
    tag  == "1.0.0"
}

is_vulnerable(image, namespace) {
	not contains(image, "@")
	version := split(image, ":")
	tag := version[count(version)-1]
    not startswith(tag, "v")
	tag <= "0.49"
}
is_vulnerable(image, namespace) {
	not contains(image, "@")
	version := split(image, ":")
	tag := version[count(version)-1]
    not startswith(tag, "v")
	tag  == "1.0.0"
}

is_vulnerable(image, namespace) {
    configmaps := [configmap | configmap = input[_]; configmap.kind == "ConfigMap"]
	configmap_on_ingress_namespace := [configmap |  configmap= configmaps[_]; configmap.metadata.namespace == namespace]
	config_maps_with_snippet := [configmap |  configmap= configmap_on_ingress_namespace[_];  configmap.data["allow-snippet-annotations"] == "false"]
	count(config_maps_with_snippet) < 1
}


is_tag_image(image) {
    reg := ":[\\w][\\w.-]{0,127}(\/)?"
    version := regex.find_all_string_submatch_n(reg, image, -1)
    v := version[_]
    img := v[_]
    not endswith(img, "/")
}