package armo_builtins

deny[msga] {
	deployment := input[_]
	deployment.kind == "Deployment"
	image := deployment.spec.template.spec.containers[i].image
	isNginxImage(image)
	isTagImage(image)
	result := isVulnerable(image, deployment.metadata.namespace, i)
	msga := {
			"alertMessage": sprintf("You may be vulnerable to CVE-2021-25742. %v", [deployment]),
			"alertObject": {"k8SApiObjects": [deployment]},
				"failedPaths": [result],
		}
}

	
isNginxImage(image) {
	contains(image, "nginx-controller")
}

isNginxImage(image) {
	contains(image, "ingress-controller")
}

isNginxImage(image) {
	contains(image, "ingress-nginx")
}

isVulnerable(image, namespace, i) = path {
	contains(image, "@")
	version := split(image, ":")
	tag := split(version[count(version)-2], "@")[0]
    startswith(tag, "v")
    tag <= "v0.49"
	path = sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
}
	
isVulnerable(image, namespace, i) = path {
	contains(image, "@")
	version := split(image, ":")
	tag := split(version[count(version)-2], "@")[0]
    startswith(tag, "v")
    tag  == "v1.0.0"
	path = sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
}

isVulnerable(image, namespace, i) = path {
	not contains(image, "@")
	version := split(image, ":")
	tag := version[count(version)-1]
    startswith(tag, "v")
	tag <= "v0.49"
	path = sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
}

isVulnerable(image, namespace, i) = path {
	not contains(image, "@")
	version := split(image, ":")
	tag := version[count(version)-1]
    startswith(tag, "v")
	tag  == "v1.0.0"
	path = sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
}

###### without 'v'
	
isVulnerable(image, namespace, i) = path {
	contains(image, "@")
	version := split(image, ":")
	tag := split(version[count(version)-2], "@")[0]
    not startswith(tag, "v")
    tag <= "0.49"
	path = sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
}
	
isVulnerable(image, namespace, i) = path {
	contains(image, "@")
	version := split(image, ":")
	tag := split(version[count(version)-2], "@")[0]
    not startswith(tag, "v")
    tag  == "1.0.0"
	path = sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
}

isVulnerable(image, namespace, i)  = path{
	not contains(image, "@")
	version := split(image, ":")
	tag := version[count(version)-1]
    not startswith(tag, "v")
	tag <= "0.49"
	path = sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
}
isVulnerable(image, namespace, i) = path {
	not contains(image, "@")
	version := split(image, ":")
	tag := version[count(version)-1]
    not startswith(tag, "v")
	tag  == "1.0.0"
	path = sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
}

isVulnerable(image, namespace, i) = path {
    configmaps := [configmap | configmap = input[_]; configmap.kind == "ConfigMap"]
	configmapOnIngressNamespace := [configmap |  configmap= configmaps[_]; configmap.metadata.namespace == namespace]
	configMapsWithSnippet := [configmap |  configmap= configmapOnIngressNamespace[_];  configmap.data["allow-snippet-annotations"] == "false"]
	count(configMapsWithSnippet) < 1
	path = "data['allow-snippet-annotations']"
}


isTagImage(image) {
    reg := ":[\\w][\\w.-]{0,127}(\/)?"
    version := regex.find_all_string_submatch_n(reg, image, -1)
    v := version[_]
    img := v[_]
    not endswith(img, "/")
}