package armo_builtins

deny[msga] {
	node := input[_]
    node.kind == "Node"
    
    startswith(node.status.nodeInfo.containerRuntimeVersion,"containerd://")
    containerdVersion := substring(node.status.nodeInfo.containerRuntimeVersion,13,-1)
    containerdVersionArr := split(containerdVersion, ".")
    majorVersion := to_number(containerdVersionArr[0]) 
    minorVersion := to_number(containerdVersionArr[1]) 
    subVersion := to_number(containerdVersionArr[2]) 
    
    isVulnerableVersion(majorVersion,minorVersion,subVersion)

    path := "status.nodeInfo.containerRuntimeVersion"

 	msga := {
			"alertMessage": "You are vulnerable to CVE-2022-23648",
    		"alertObject": {
               "k8SApiObjects": [node]
            },
			"failedPaths": [path],
            "fixPaths":[],
	}
}


isVulnerableVersion(majorVersion, minorVersion, subVersion) {
	majorVersion == 0
} 

isVulnerableVersion(majorVersion, minorVersion, subVersion) {
	majorVersion == 1
	minorVersion < 4
}

isVulnerableVersion(majorVersion, minorVersion, subVersion) {
	majorVersion == 1
	minorVersion == 4
	subVersion < 12
}

isVulnerableVersion(majorVersion, minorVersion, subVersion) {
	majorVersion == 1
	minorVersion == 5
	subVersion < 10
}	

isVulnerableVersion(majorVersion, minorVersion, subVersion) {
	majorVersion == 1
	minorVersion == 6
	subVersion < 1
}	

