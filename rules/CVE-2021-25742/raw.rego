package armo_builtins


deny[msga] {
	deployment := input[_]
	deployment.kind == "Deployment"
	image := deployment.spec.template.spec.containers[_].image
	contains(image, "nginx-ingress-controller")
	isVulnerable(image, deployment.metadata.namespace)
		
	msga := {
			"alertMessage": sprintf("You may be vulnerable to CVE-2021-25742. %v", [deployment]),
			"alertObject": {"k8SApiObjects": [deployment]},
		}
}
	
isVulnerable(image, namespace) {
	version := split(image, ":")
	version[count(version)-1] <= "0.49"
}
	
isVulnerable(image, namespace) {
	version := split(image, ":")
	version[count(version)-1] == "1.0.0"
}
	
isVulnerable(image, namespace) {
	version := split(image, ":")
	version[count(version)-1] == "latest"
}
	
isVulnerable(image, namespace) {
     configmaps := [configmap | configmap = input[_]; configmap.kind == "ConfigMap"]
	configmapOnIngressNamespace := [configmap |  configmap= configmaps[_]; configmap.metadata.namespace == namespace]
	configMapsWithSnippet := [configmap |  configmap= configmapOnIngressNamespace[_];  configmap.data["allow-snippet-annotations"] == "false"]
	count(configMapsWithSnippet) < 1
}
	
		 
		 